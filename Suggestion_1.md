# 数据同步：方案一

## 一．背景

1.完成本地服务端和云服务端之间的数据交互，数据有本地服务端同步到云服务端的数据，也有云服务端同步到本地服务端的数据。

2.本地服务端为局域网，云服务端为公网，请求只能有本地服务端发起：

1）本地服务端数据同步发送到云服务端：直接请求

2）本地服务端请求接收云服务端同步数据：分为两次请求，一次取数据，第二次返回云服务端所取数据插入本地服务端数据表的结果

## 二．主要问题

1.如何保证数据不会丢失：业界有无成熟的方案？

1）本地服务端发送数据到云服务端【云服务端为接收】，如果云服务端接收一瞬间断电，那么，如果云服务端将所接收数据成功插入了云服务端数据表，那么，本地服务端不认为数据已经成功同步，还会再次发起请求

2）本地服务端接受云服务端数据也同样，如果本地服务端已经接受了数据，在准备返回数据插入业务数据表的结果时，断电了，那么云服务端就会等待。

2.如何保证安全性，token何时生成，服务端之间的安全性业界一般是怎么做的

3.数据一致性：场景

1）加入本地服务端作为分店，加盟云服务端总店，分店已经有会员数据，分店和总店间需要共享会员数据，而分店需要保证在断网情况下能够独立运营。也就是只有会员数据互通有无，这种情况下，如果总店与分店有相同会员数据【通过手机号识别】，如何处理为好？会员数据的唯一性，采用哪个会员id，更改id后，其他数据如何处理？

### 三．交互方案说明：

**1.本地服务端同步定时任务管理模块业务方案**

| 功能说明     | 同步定时任务管理模块分为两个功能子模块 1.模块一：接收同步定时任务输入【标识】，确认是否发起心跳请求 1）判断本地服务端是否开启云服务端同步任务【配置表数据是否完整】 2）若为否，则： （1）查询《同步数据表》，确认本地最高同步优先级数据值 （2）关闭同步定时器，发起心跳请求 2.模块二；接收同步结果数据和本地服务端和云服务端最高同步优先级数据值，根据输入，确认下一步动作 1）发送本地服务端待同步数据到云服务端成功 （1）若本地服务端和云服务端最高同步优先级数据的值均不为‘0’，或一方不为‘0’，根据比较结果再次发起交互请求； （2）若本地服务端和云服务端最高同步优先级数据的值均为‘0’，则发起发送实时统计数据到云服务端的请求；然后开启同步定时器 2）发送本地服务端待同步数据到云服务端失败： （1）若本地服务端和云服务端最高同步优先级数据的值均不为‘0’，或一方不为‘0’，根据比较结果再次发起交互请求； （2）若本地服务端和云服务端最高同步优先级数据的值均为‘0’，则发起发送实时统计数据到云服务端的请求；然后开启同步定时器 3）接收云服务端待同步数据成功，且返回所接收待同步数据插入本地服务端业务数据表的结果数据成功： （1）若本地服务端和云服务端最高同步优先级数据的值均不为‘0’，或一方不为‘0’，根据比较结果再次发起交互请求； （2）若本地服务端和云服务端最高同步优先级数据的值均为‘0’，则发起发送实时统计数据到云服务端的请求；然后开启同步定时器 4）接收云服务端待同步数据成功，且返回所接收待同步数据插入本地服务端业务数据表的结果数据失败： （1）开启同步定时器 5）接收云服务端待同步数据失败 （1）开启同步定时器 6）发送实时统计数据的请求结束【无论成功失败】 （1）开启同步定时器 7）请求云服务端时，网络链接失败 （1）开启同步定时器 |
|--------------|-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 本地服务端定时器触发，或接收同步业务完成标识的触发                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 需求输入     | 1.本地服务端同步定时器 2.待同步数据结束标志数据：为交互的结果数据【也就是交互的数据可能成功】 3.实时统计数据请求完成标识数据【实时统计数据请求，不区分失败和成功】                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 输入来源     | 参见上述说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 调用接口     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 输出结果     | 根据‘同步定时任务管理模块’的输出： 1.向云服务端发起心跳请求 （1）请求成功后，则参照功能说明完成后续业务动作 （2）若无待同步数据，或心跳请求失败，则重启同步定时器 2.向云服务端发起待同步数据交互请求 3.向云服务端发起实时统计数据交互请求                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 关键程序逻辑 | 一．判断同步业务是否开启的方案： 1.判断配置表是否设置云服务端域名，以及对应‘同步业务数据’，以及本地服务端配置表同步开启标识为‘开启’【设置同步开启标识时，需要判断‘同步业务数据’是否完成设置，若未完成设置，则禁止设置开启】 2.若同步业务已开启，输出同步定时任务： 1）关闭同步定时器【方案：设置同步任务触发开关（标识数值），同步定时任务执行前，判断这个值是否允许执行，若不允许，则不执行；也就是通过这个值可以时限同步任务开工的功能】 二．同步定时任务管理模块管理同步业务的触发动作： 1.接收同步定时任务触发后，判断本地服务端是否开启云服务端同步任务，若否，则结束同步任务；若是，则关闭同步定时器，同时发起同步心跳请求，以及完成后续的同步业务 1）若有待同步数据，判断优先级【执行第2步】，根据优先级发起请求； 2）若无待同步数据，或心跳请求失败，则重启同步定时器 2.接收待同步数据的同步请求交互任务完成的标志数据，以及同步数据优先级数据，根据这些数据触发下一步动作 1）成功请求的同步标识数据： （1）若仍有待同步数据，则继续触发同步任务【非心跳请求】 （2）若无同步任务，则请求云服务端，发送实时统计表数据，然后开启同步定时器 说明：这里有个待同步数据优先级比较模块 2）失败请求【包括网络连接问题、请求超时问题】的同步标识数据：重启同步定时器【对应post、get请求，请求失败后有不同业务动作，这一动作在重启同步定时器之前完成】 3.接收实时统计数据同步完成标识数据：完成后即重启同步定时器                                                                                                                                                                                                                                       |
| 测试方法     | 预置数据，白盒测试                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 测试数据     | 分别设置开启关闭同步标识测试                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |

**2.本地服务端同步定时触发业务方案**

| 功能说明     | 同步由本地服务端发起，包括心跳请求、业务请求、实时同步数据请求三大类： 1.心跳请求用于确认云服务端是否做好同步准备，以及获取必要的同步准备的数据参数，包括change值比较数组； 2.业务请求就是本地服务端和云服务端之间待同步数据的交互： 1）定义为优先级越高的数据，越先同步； 2）每次交互数据时，均需要返回当前最高优先级最高的数据。采用multi-curl方案时，单独起一个获取优先级数据的请求； 3）一次只同步一个类别的数据 3.实时同步数据请求：无论发送成功或失败，均需要重新开启同步定时器                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 本地服务端定时任务，或‘定时任务管理模块’触发                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 需求输入     | 1.本地同步开启标识：本地服务端配置表获取 2.云服务端同步允许：云服务端《分店（企业）详情表》获取 1）分店号 2）本地服务端同步接口域名 3）是否‘有效’ 3.本地服务端被同步数据优先级标识：同步数据发送表获取 4.云服务端被同步数据优先级标识：心跳请求及随后交互请求获取 5.本地服务端同步业务数据 6.云服务端同步业务数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 输入来源     | 参见上述说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 调用接口     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 输出结果     | 同步由本地服务端发起： 1.接收同步定时任务触发后，判断本地服务端是否开启云服务端同步任务，若否则结束同步任务； 2.若本地服务端开启了云服务端同步业务，则由本地服务端向云服务端发起心跳请求，确认云服务端是否做好同步业务的准备，若否，则提示后，结束同步业务【本地服务端数据表给出提示标识】 3.若云服务端开启了同步业务，则心跳请求返回云服务端需要同步数据的最高优先级标识： 1）判断本地服务端《同步数据接收表》是否有‘待确认同步结果’的同步数据，若有则首先向云服务端发起请求，完成‘待确认同步结果’同步数据的结果数据交互。完成后，然后执行第4步 2）若《同步数据接收表》没有‘待确认同步结果’的同步数据，则直接执行第4步 4.本地服务端根据返回的云服务端‘最高优先级标识’值，与本地服务端‘最高级优先值’比较 5.若本地服务端大于云服务端，则本地服务端发起post请求，把本地服务端数据发送到云服务端，云服务端处理完成，返回成功或失败标识，本地服务端根据‘标识’完成下一步动作； 6.若本地服务端小于云服务端，则本地服务端发起get请求，取回云服务端同步数据，本地服务端处理完成，返回成功或失败标识，云服务端根据‘标识’完成下一步动作【回调处理】； |
| 关键程序逻辑 | 本地服务端定时任务，或‘定时任务管理模块’触发                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 测试方法     | 1.本地同步开启标识：本地服务端配置表获取 2.云服务端同步允许：云服务端《分店（企业）详情表》获取 1）分店号 2）本地服务端同步接口域名 3）是否‘有效’ 3.本地服务端被同步数据优先级标识：同步数据发送表获取 4.云服务端被同步数据优先级标识：心跳请求及随后交互请求获取 5.本地服务端同步业务数据 6.云服务端同步业务数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 测试数据     | 分别设置开启关闭同步标识测试                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |

**3.本地服务端请求将本地服务端同步数据发送到云服务端**

| 功能说明     | 本地服务端根据任务指令，把本地同步数据发送到云服务端：1.根据类别优先级及同步数据创建时间【先进先出】，将《同步数据表》取出，插入《同步数据发送表》， 2.打包请求数据，向云服务端发起请求 1）若同步成功，删除《同步数据发送表》数据 2）若失败，刷新《同步数据发送表》对应数据，并回退到《同步发送表》 说明：基于安全性考虑，不考虑数据库直接请求方式                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 本地服务端‘定时任务管理模块’触发                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 需求输入     | 1.本地服务端同步数据 1）同步数据id 2）同步类别值【也是同步优先级值】 3）同步数据插入时间 2.本地同步数据成功或失败标识：接口返回数据 3.本地服务端同步优先级标识数据：本地获取，为本次同步之后的最高优先级数据 4.云服务端同步优先级标识数据 5.云服务端待同步共享会员数据标识：含义是云服务端有共享会员数据待同步到本地 6.云服务端id 7.分店id 8. token                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 输入来源     | 参照前述说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 调用接口     | 业务数据同步请求接口                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 输出结果     | 预计采用multi-curl方案一次发起多条数据请求： 一．请求操作成功，所接收返回数据验证通过：完成本地同步数据表业务数据的操作； 1.根据返回值完成《同步数据发送表》同步数据的操作 1）若同步数据同步成功，删除《同步数据发送表》、同步数据表的对应同步数据 （2）判断《特情表》有无与同步数据来源数组相同【发送或接收的类别也需一致】的特情数据，若有则删除 2）若同步数据插入数据表失败，或者同步数据验证失败，累加同步数据的失败次数，然后判断： （1）若累加失败次数小于3，删除《同步数据发送表》对应数据，并回退到《同步数据表》，回退前，判断同步表是否与回退同步数据来源数组相同的同步数据：若有，则丢弃对应数据；若无，则根据data_from_detail，重新打包data_detail字段，然后将重新拼接的数据回退插入《同步数据表》 （2）累加失败次数等于3，删除《同步数据发送表》对应数据，并将数据插入《特情数据表》。插入时，判断特情表是否与插入同步数据来源数组相同的同步数据：若有，则覆盖刷新原特情数据【先删后插入】；若无，则将数据插入《特情数据表》 2.获取本地同步优先级标识数据，以及与返回的云服务端同步优先标识数据比较，然后调用《定时任务管理模块》，确认下一步业务动作 二．若请求链接失败，则再次请求，若连续三次失败： 1.删除《同步数据发送表》对应数据，并回退到《同步数据表》，数据回退时，同步失败次数不累加‘1’。回退前，判断同步表是否与回退同步数据来源数组相同的同步数据：若有，则丢弃对应数据；若无，同步数据回退插入《同步数据表》 2.然后传值链接失败标识数据，调用《定时任务管理模块》，确认下一步业务动作 说明：若业务数据同步请求，进行change值比对，则需要： 1.根据返回的change值比较数组，打包需要同步的所有业务基础数据，插入同步数据表【若验证返回的change值比较数组失败，不影响其他业务动作操作】 2.若对应于change值的所有业务基础数据均插入同步数据表，会有较多重复插入的数据；若只插入不一致数据，那么需将云服务端对应change值业务基础数据的所有数据id和set-time字段返回本地服务端，通过比较，确认需要同步哪些数据到云服务端，但这样做数据交互量大且复杂。 |
| 关键程序逻辑 | 一《同步数据表》同步数据插入《同步数据发送表方案》 1.根据‘定时任务管理模块’的输出待同步数据的类别号，从《同步数据表》取出待同步数据同步数据来源数组，若个数小于100个，则全部取出，若个数大于100个，则按时间顺序取出前100个 说明：目前的方案定义一次请求，只处理一种类别的同步数据，这样云服务端在处理数据时，可以一次性打开所需要的数据表，完成同步数据的操作 2.确认同步数据发送表是否有待同步数据，若有，取出同步数据发送表待同步数据的同步数据来源数组，比较待同步数据来源数组与同步数据发送表的同步数据来源数组【先类别筛选再比较，正常情况下不会出现这种情况】 3.根据比较结果，从《同步数据表》取出没有与《同步数据发送表》相同来源的数据，并插入《同步数据发送表》 二．数据同步的请求方案 1.根据定时任务触发：按数据类别【不按类别需要测试，若可行则接受，这种情况下可简化数据优先级】每次100个请求，根据测试结果确定具体个数【设定超时间3.5秒（测试确定）】 1）若数据大于100个，则发起100个请求 2）若数据小于100个，则有多少个待同步数据，就发起多少个请求 2.依照以下顺序完成对应动作： 1）发起请求 3）接收请求结果数据 3.完成请求结果数据处理： 1）若同步成功，删除《同步数据发送表》、《同步数据表》或《会员同步数据表》数据 （1）判断《特情表》有无与同步数据来源数组相同【发送或接收的类别也需一致】的特情数据，若有则删除 2）若失败，且累加失败次数小于3，删除《同步数据发送表》对应数据，并回退到《同步数据表》，回退前，判断同步表是否与回退同步数据来源数组相同的同步数据 （1）若有，则丢弃对应数据 （2）若无，则将回退数据插入《同步数据表》 3）若失败，且累加失败次数等于3，删除《同步数据发送表》对应数据，并将数据插入《特情数据表》。插入时，判断特情表是否与插入同步数据来源数组相同的同步数据 （1）若有，则覆盖刷新原数据【先删后插入】 （2）若无，则将数据插入《特情数据表》 三.根据接收的云服务端数据优先级，调用‘定时任务管理模块’ （1）若仍有待同步数据，则重复第1步 （2）若无待同步数据，则开启定时任务触发                                     |
| 测试方法     | 本地服务端和云服务端协同测试，白盒测试                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 测试数据     | 预置各类数据，确认同步标识、同步类别、业务类别是否得到遵守                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |

**4.云服务端接收本地服务端发送业务同步数据的请求**

| 功能说明     | 云服务端接收到本地服务端发送业务同步数据的请求，验证通过后，将同步数据插入业务数据表，并返回成功标识；若验证失败，或数据表操作失败，则返回本地服务端对应失败标识 说明：云服务端暂不采用《同步数据接收表方案》，也就是云服务端接收到请求后，直接验证数据，通过后就进行数据表操作，并完成结果返回                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 接收到本地服务端发送业务同步数据的请求                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 需求输入     | 1.本地服务端同步数据 1）同步数据id 2）同步类别值【也是同步优先级值】 3）同步数据插入时间 2.本地同步数据成功或失败标识：接口返回数据 3.本地服务端同步优先级标识数据：本地获取，为本次同步之后的最高最高优先级数据 4.云服务端同步优先级标识数据 5.云服务端待同步共享会员数据标识：含义是云服务端有共享会员数据待同步到本地 6.云服务端id 7.分店id 8. token                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 输入来源     | 所有的数据接口及云服务端计算获取                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| 调用接口     | 业务数据同步请求接口                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 输出结果     | 一．接收请求操作成功，所接收数据验证通过： 1.解析所接收本地服务端的同步数据，并插入业务数据表。 2.返回结果标识 3.删除接收同步数据的暂存数据 二．接收数据成功，但验证失败或插入数据表失败： 1.返回结果标识 2.删除接收同步数据的暂存数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| 关键程序逻辑 | 一．接收请求后的验证：作为统一的方案，有一个数据解压解密的业务动作 1.唯一性及安全性验证（采用加时间戳方案，时间戳在心跳请求时获取）：采用封装，也就是token、本地服务端id、云服务端id采用统一方案验证 2.验证：所接收同步数据的‘data_detail’字段，与data_from_detail字段中表单名和表单id与data_detail中的表单名和表单id一致且完整 3.验证：所接收同步会员数据里的会员id没有与云服务端会员表里会员id相同 二．数据表操作动作：需要事务【采用multi-curl方案，统一返回所有同步数据的操作结果数组】 1.数据表的动作根据具体业务确认【需要给出数据方案】 2.若有数据插入失败，则生成对应的失败标识： 1）刷新‘操作结果数组’ 2）判断‘操作结果数组’所有数据是否都有操作结果的值：若有，则打包‘操作结果数组’返回数据；若否，则等待其他同步数据操作结果的值 说明：统一返回‘操作结果数组’的方案需要确认multi-curl是否支持，单独返回请求数据也可接受，但这种情况下，需要确认数据的等幂性【部分数据需要先查找确认数据表是否有此数据，若有则刷新，否则就是插入】 3.获取云服务端优先级最高的待同步数据类别的标识、共享类待同步会员数据表时。默认值为‘0’【单独请求】 4.*比较本地服务端和云服务端change值，生成change值比较数组【不做】* 5.打包返回数据并返回本地服务端 |
| 测试方法     | 根据上述关键逻辑设计测试数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 测试数据     | 参照关键逻辑，采用模拟云服务端数据测试：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |

**5.本地服务端请求获取云服务端订单数据和非共享类会员-第一次请求**

| 功能说明     | 分店服务端向云服务端请求数据分为两个大的步骤： 1.本地服务端向云服务端发起获取同步数据请求【第一次】： 1）获取云服务端订单数据和非共享会员数据，云服务端验证通过后，返回对应同步数据到本地； 2）本地服务端验证通过后，解析数据，将数据插入《同步数据接收表》。若某条数据插入失败，则直接标记此条数据同步失败【数据仍以同步id为唯一性拼接插入《同步数据接收表》，或直接根据该数据的请求，将其标为同步失败】 说明：同步数据id需要单独验证，任一同步id错误，则整个请求数据均返回【返回‘操作结果数组’值均为请求失败】 3）本地服务端根据业务类别，将数据插入指定业务数据表，再根据插入结果【成功或失败：即‘操作结果数组’的值】刷新《同步数据接收表》 2.本地服务端打包同步结果数据，发起返回‘操作结果数组’数据到云服务端的请求【第二次】：注意与第一次请求有数据依赖关系 1）同步结果数据的数据结构 （1）同步数据id （2）同步结果：分为接收数据失败、插入数据表失败及成功 （3）分店id 2）请求成功，则删除所有本地《同步数据接收表》数据 （1）同步数据失败次数加‘1’，若同步失败次数等于3，则将对应数据插入本地服务端《同步特情表》 （2）若同步失败次数小于3，则直接删除数据 （3）若同步成功，则直接删除数据 3.若返回‘操作结果数组’请求失败【任何原因】，则再次请求【不超过三次，不再请求也可】，若仍然失败，则数据保留在《同步数据接收表》。同时调用‘定时任务管理模块’ 说明：遗留的问题是，multi-curl是同时多条数据发起请求，但返回结果有先后，是等第一次请求的数据均返回且处理后，再发起第二次请求，还是每个接收数据处理完成后再发起第二次请求，需要确认。目前的方案暂定是统一发起第二次请求                                                                                                                                                                                                                                |
|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 本地服务端定时请求，或‘定时任务管理模块’触发，以下为第一次请求                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 需求输入     | 1.云服务端同步数据：来自于云服务端同步数据表 1）同步数据id 2）同步类别值【也是同步优先级值】 3）同步数据插入时间 2.本地服务端处理所接收同步数据成功或失败标识：本地服务端计算结果 3.本地服务端同步优先级标识数据：本地获取 4.云服务端同步优先级标识数据：云服务端获取，为本地同步之后的最高优先级数据 5.云服务端待同步共享会员数据标识：意为云服务端有共享会员数据待同步到本地 6.云服务端id 7.分店id 8. token                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 输入来源     | 参见上述说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 调用接口     | 定时业务数据获取同步接口（第一次请求）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 输出结果     | 以下针对单条同步数据描述： 1.请求操作成功，所接收同步数据验证通过： 1）把同步数据插入《同步数据接收表》数据表 2）解析同步数据【可能对应与多个业务数据表数据】，并将解析的数据插入对应业务数据表，以及采用数据插入业务数据表的结果刷新《同步数据接收表》对应同步数据 3）确认《同步数据接收表》对应的‘操作结果数组’其他数据是否完成操作，若完成则调用第二次请求 说明： A．同步数据插入业务数据表的动作需要事务，任一个业务数据表的插入失败，均需要回退，并标记‘操作结果数组’对应数据位的值为同步失败。 B．因为请求时，不知道云服务端同类别待同步数据的个数【也不能定义个数，个数本身是变动的】，本地服务端发情请求的个数为100个，所有可能有的返值为‘0’，这种情况下，只统计记录返回的请求个数，数据不在‘操作结果数组’体现 2.请求操作成功，所接收同步数据验证通过，插入《同步数据接收表》数据表时失败 1）根据同步数据id直接拼接一条数据，标记‘操作结果数组’此条同步数据对应数据位的值为同步失败 2）确认《同步数据接收表》对应的‘操作结果数组’其他数据是否完成操作，若完成则调用第二次请求 说明：需要确认multi-curl是否支持此方案，若不支持，则将multi-curl同一批次请求回来的数据全部标记为失败，也就是请求获取数据失败 3.若请求链接失败，则再次请求，若失败：则调用‘定时任务管理模块’确认下一步动作                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 关键程序逻辑 | 一．请求返回的数据验证：包含数据验证，数据验证若失败则标记对应‘操作结果数组’为同步失败，直接发起第二次请求 1.验证：所有同步id唯一且正确，若否，则返回当次同时请求的同步数据‘操作结果数组’值为同步失败，数据不插入《同步数据接收表》，也无后续业务动作 2.验证：其中data_from_detail中表单名是否与data_detail中的表单名一致且完整；若否，则返回当次同时请求的同步数据‘操作结果数组’值为同步失败，也无后续业务动作 3.所接收同步数据在《同步数据接收表》没有相同表单相同数据id的数据条目【当前方案是请求前会处理完之前《同步数据接收表》的遗留数据，不应有此问题。这里是方案备份】，若有，刷新原数据 4.验证：云服务端待同步数据的优先级标识数据，是数字且为定义范围内的数字【验证失败也继续执行】 5.验证：云服务端待同步共享会员数据标识数据【验证失败也继续执行】 6.验证：返回数据的个数与请求数据的个数一致【若有返回值为‘0’的请求，则记录其个数，然后与同步数据接收表的数据相加值等于请求个数】 7.验证：所取回同步会员数据里的会员id没有与本地服务端《会员表》里会员id相同 二．将所接收同步数据插入《同步数据接收表》：若插入失败，则根据同步id重新拼接此条数据插入《同步数据接收表》，标记对应‘操作结果数组’为同步失败 三．将同步数据插入业务数据表【这里是单条同步数据动作】：需要事务 1.业务验证：若失败则标记对应‘操作结果数组’为同步失败，同时确认《同步数据接收表》对应的‘操作结果数组’其他数据是否完成操作，若完成则调用第二次请求；若成功，则继续插入业务数据表的动作 2.插入业务数据表：需要事务 1）若业务数据插入失败，则标记对应‘操作结果数组’为同步失败。同时确认《同步数据接收表》对应的‘操作结果数组’其他数据是否完成操作，若完成则调用第二次请求 2）若业务数据插入成功，则标记对应‘操作结果数组’为同步成功。同时确认《同步数据接收表》对应的‘操作结果数组’其他数据是否完成操作，若完成则调用第二次请求 |
| 测试方法     | 灰盒测试，根据上述关键逻辑设计测试数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 测试数据     | 参照关键逻辑，采用模拟云服务端数据测试：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |

**6.云服务端接收本地服务端获取订单数据和非共享类会员的请求-第一次请求**

| 功能说明     | 一.云服务端接收到本地服务端获取订单数据和非共享类会员的请求【第一次】： 1.根据业务数据类别，从云服务端《同步数据表》或《会员同步数据表》取出待同步数据【若超出100条，按时间顺序取出】 2.验证所取出同步数据的同步id【避免脏数据】 3.验证通过后，将取出的同步数据插入《同步数据发送表》，并响应请求，返回请求的同步数据到本地； 二.云服务端接收到本地服务端返回第一次请求‘操作结果数组’数据的请求【第二次，采用multi-curl方案】，验证通过后： 1.若同步数据同步成功，删除《同步数据发送表》的对应同步成功的同步id数据 2.若同步数据插入数据表失败，或者同步数据验证失败，累加同步数据的失败次数，然后判断： 1）若累加失败次数小于3，删除《同步数据发送表》对应数据，并回退到《同步数据表》，回退前，判断同步表是否与回退同步数据来源数组相同的同步数据：若有，则丢弃对应数据；若无，则根据data_from_detail，重新打包data_detail字段，然后将重新拼接的数据回退插入《同步数据表》 2）累加失败次数等于3，删除《同步数据发送表》对应数据 3.获取云服务端同步优先级标识数据，以及与请求交互的返回数据打包，返回本地服务端                                                                                                                                                                                                                                                                                                                                                                |
|--------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 接收本地服务端的获取同步数据的请求                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| 需求输入     | 1.云服务端同步数据：来自于云服务端同步数据表 1）同步数据id 2）同步类别值【也是同步优先级值】 3）同步数据插入时间 2.本地服务端处理所接收同步数据成功或失败标识：本地服务端计算结果 3.本地服务端同步优先级标识数据：本地获取 4.云服务端同步优先级标识数据：云服务端获取，为本地同步之后的最高优先级数据 5.云服务端待同步共享会员数据标识：意为云服务端有共享会员数据待同步到本地 6.云服务端id 7.分店id 8. token                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 输入来源     | 参见上述说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| 调用接口     | 定时业务数据获取同步接口（第一次请求）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 输出结果     | 一．云服务端验证请求数据通过： 1.根据业务数据类别，从云服务端《同步数据表》或《会员同步数据表》取出待同步数据【若超出100条，按时间顺序取出】 2.验证所取出同步数据的同步id【避免脏数据】 3.验证通过后，将取出的同步数据标记为相同同步时间，插入《同步数据发送表》： 1）插入前根据同步数据来源字段，判断《同步数据发送表》是否有待同步数据【包括待确认结果同步数据】，若无，则将取出待同步数据插入《同步数据发送表》，且标记为相同的插入时间 2）若有，比较从《同步数据表》所取出同步数据的同步来源字段，若有相同来源的同步数据，则剔除相同来源字段的同步数据，然后再将其他取出待同步数据插入《同步数据发送表》，且标记为相同的插入时间【先类别筛选再比较，正常情况下不会出现这种情况，这样做目的是容错。】 说明： A．**刷新覆盖同源数组相同的数据条目**也是一种方案，但需要本地服务端逻辑支持且对应数据未处于交互请求动作中 B．对应于本地服务端的请求，被剔除数据不影响返回请求的个数，也就是本地发起了100个请求，若因为数据剔除，只剩有99个同步数据，那么最后一个请求的返回数据设为‘0’ 4.打包插入《同步数据发送表》的待同步数据，返回本地服务端。返值为‘0’的数据不插入《同步数据发送表》 5.若待同步类别的数据为‘0’【即同步数据表没有对应类别的待同步数据】，则返回本地服务端‘0’ 说明：第3、4步需要事务保证，也就是返回数据失败，则需要回退插入《同步数据发送表》的同步数据 二．接收请求操作成功，但云服务端验证失败，则直接返回本地服务端失败信息，即不返回云服务端的待同步数据 |
| 关键程序逻辑 | 一.接收第一次请求后验证 1. 接收请求后的验证：唯一性及安全性验证（采用加时间戳方案，时间戳在心跳请求时获取）：采用封装，也就是token、本地服务端id、云服务端id采用统一方案验证 二.验证后动作 1.根据所接收请求里的数据类别，打包对应请求的返回数据【本地服务端每次multi-curl发起100个请求】 1）若《同步数据表》同类别数据大于100个，则按时间顺序打包最早插入数据表同类别同步数据 2）若数据小于100个，则有多少个待同步数据，就返回多少个请求，剩余的请求对应于同步数据的数据位返回‘0’ 3）打包优先级最高的待同步数据类别的标识、共享类待同步会员数据表时。默认值为‘0’ 2.返回打包的同步数据及优先级标识数据到本地服务端                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 测试方法     | 灰盒测试，根据上述关键逻辑设计测试数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 测试数据     | 参照关键逻辑，对应于不同类别的同步数据测试。需要模拟不同请求的请求成功、验证成功；请求失败、验证失败的场景                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |

**7.本地服务端发起返回云服务端同步操作结果数组数据的请求-第二次请求**

| 功能说明     | 分店服务端在处理完所接收云服务端待同步数据后， 根据‘操作结果数组’打包请求数据，向云服务端发起第二次请求，若请求成功，完成本地服务端所接收待同步数据的处理；若请求失败，则不处理《同步数据接收表》里的待同步数据，根据请求失败的标识，调用‘定时任务管理模块’确认下一步动作。 说明：第二次请求可以为multi-curl请求，也可以是基于单个‘操作结果数组’的请求，以下方案基于multi-curl请求                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
|--------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 本地服务端请求获取云服务端待同步数据，且处理完成功后，生成‘操作结果数组’，然后顺延执行第二次请求触发此动作；或者‘定时任务管理模块’接收定时任务后，在心跳请求后，确认有上一次同步接收数据未处理完成【即操作结果数组没有反馈给云服务端】，即发起此请求                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 需求输入     | 1.操作结果数组【数据结构如下】 （1）同步数据id （2）同步结果：分为接收数据失败、插入数据表失败及成功 2.云服务端同步优先级标识数据：云服务端获取，为本地同步之后的最高优先级数据 3.云服务端待同步共享会员数据标识：意为云服务端有共享会员数据待同步到本地 4.云服务端id 5.分店id 6. token                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 输入来源     | 参见上述说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| 调用接口     | 同步接收数据处理结果返回接口（第二次请求）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| 输出结果     | 一.以下针对单条同步数据描述： 1.请求操作成功，所接收返回数据验证通过： 1）对应同步数据插入业务数据表成功，则删除本地《同步数据接收表》数据 （1）判断《特情表》有无与同步数据来源数组相同【发送或接收的类别也需一致】的特情数据，若有则删除 2）对应同步数据验证失败或插入业务数据表失败： （1）所接收同步数据失败次数加‘1’，若同步失败次数等于3，则将对应数据插入本地服务端《同步特情表》 （2）若同步失败次数小于3，则直接删除数据 2.若请求成功，但返回云服务端验证数据失败，则再次请求，若失败：则将对应同步数据插入特情表，同时删除《同步数据接收表》对应同步数据 说明：这种情况下，特情表将同时有插入业务数据同步成功（也就是已经将云服务端同步数据成功插入了业务数据表）和业务数据同步失败的数据 3.若请求链接失败，则再次请求，若失败：则不对《同步数据接收表》对应同步数据做任何动作 二．对应于‘操作结果数组’所有数据确认都有返回结果后，调用‘定时任务管理模块’确认下一步动作                             |
| 关键程序逻辑 | 1.第一次请求时，需要保证每一个请求均有返回的数据，这是第二次请求的基础 2.第二次请求，若为multi-curl请求，则需要判断是否所有的请求都有结果【请求成功（同步可能为成功或失败）、请求验证失败（同步可能为成功或失败）、或请求连接失败】，在所有请求完成时，调用‘定时任务管理模块’： 1）请求链接是否成功，若不成功，则重启同步定时任务；若成功，则进行第2）步 2）判断‘云服务端同步优先级标识数据’和‘本地服务端同步优先级标识数据’【均为‘0’，则重启同步定时任务】，以及根据判断结果，执行下一步动作 说明：若请求失败或请求验证失败，均需要再次发起请求，参考方案是：在请求前建立一个请求次数数组，若返回失败数据，则判断失败次数，达到两次，即根据前述方案，处理《同步数据接收表》对应同步数据；若请求顺利完成，则刷新请求次数数组对应值为‘0’，所有请求完成时，删除此数组 3.‘云服务端同步优先级标识数据【含会员待同步数据】’单独请求获取，若获取失败，则赋值对应数据位‘0’，同样调用‘定时任务管理模块’完成下一步动作 |
| 测试方法     | 灰盒测试，根据上述关键逻辑设计测试数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |
| 测试数据     | 参照关键逻辑，采用模拟云服务端数据测试：                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               |

**8.云服务端接收本地服务端返回同步操作结果数组数据的请求-第二次请求**

| 功能说明     | 云服务端接收到本地服务端返回第一次请求‘操作结果数组’数据的请求【第二次】，验证通过后，完成数据表操作 说明：若为单个的curl请求，也就是直接发送‘操作结果数组’到云服务端，则数据验证除了安全性验证，也需要验证与第一次接收请求所返回的同步数据同步id能够一一对应。若此验证失败，则整体返回请求失败。当前确定采用multi-curl方案                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
|--------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 触发条件     | 接收本地服务端返回同步操作结果数组数据的请求                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 需求输入     | 1. 操作结果数组【数据结构如下】 （1）同步数据id （2）同步结果：分为接收数据失败、插入数据表失败及成功 2.云服务端同步优先级标识数据：云服务端获取，为本地同步之后的最高优先级数据 3.云服务端待同步共享会员数据标识：意为云服务端有共享会员数据待同步到本地 4.云服务端id 5.分店id 6. token                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| 输入来源     | 参见上述说明                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| 调用接口     | 同步接收数据处理结果返回接口（第二次请求）                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 输出结果     | 一. 验证通过： 1.若同步数据同步成功，删除《同步数据发送表》的对应同步成功的同步id数据 （1）删除《同步数据表》、《同步备忘表》【若有】对应数据 2.若同步数据在本地服务端插入业务数据表失败，或者同步数据本地服务端验证失败，累加同步数据的失败次数，然后判断： 1）若累加失败次数小于3，删除《同步数据发送表》对应数据，并回退被删除同步数据到《同步数据表》。回退前，判断同步表是否有与回退数据来源数组相同的同步数据：若有，则丢弃对应同步数据；若无，则根据data_from_detail，重新打包data_detail字段，然后将重新拼接的同步数据插入《同步数据表》 2）累加失败次数等于3，删除《同步数据发送表》对应数据 3.获取云服务端同步优先级标识数据，以及与请求交互的返回数据打包，返回本地服务端【若multi-curl请求，则获取‘云服务端同步优先级标识数据’为一个单独的请求】 二．接收请求操作成功，但云服务端数据验证失败【multi-curl单个请求返回数据】，则直接返回本地服务端失败信息 |
| 关键程序逻辑 | 验证通过： 1.若同步数据同步成功，删除《同步数据发送表》的对应同步成功的同步id数据 （1）删除《同步数据表》或《会员同步数据表》、《同步备忘表》【若有】对应数据 2.若同步数据在本地服务端插入业务数据表失败，或者同步数据本地服务端验证失败，累加同步数据的失败次数，然后判断： 1）若累加失败次数小于3，删除《同步数据发送表》对应数据，并回退被删除同步数据到《同步数据表》。回退前，判断同步表是否有与回退数据来源数组相同的同步数据：若有，则丢弃对应同步数据；若无，则根据data_from_detail，重新打包data_detail字段，然后将重新拼接的同步数据插入《同步数据表》 2）累加失败次数等于3，删除《同步数据发送表》对应数据 3.获取云服务端同步优先级标识数据，以及与请求交互的返回数据打包，返回本地服务端【若multi-curl请求，则获取‘云服务端同步优先级标识数据’为一个单独的请求】                                                                                          |
| 测试方法     | 灰盒测试，根据上述关键逻辑设计测试数据                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                |
| 测试工具     |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
| 测试数据     | 参照关键逻辑，对应于不同类别的同步数据测试。需要模拟不同请求的请求成功、验证成功；请求失败、验证失败的场景                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| 其他         |                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       |
