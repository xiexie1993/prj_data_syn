# 项目-数据同步

## 一、概述

###  1、 编写目的

+  为项目的系统的开发设计的依据与指导。
+  为参与该项目的编程人员提供依据；
+  为修改、维护提供条件；  
+  项目负责人将按计划书的要求布置和控制开发工作全过程；  
+  项目质量保证组将按此计划书做阶段性和总结性的质量验证和确认。

### 2、 读者对象

+  项目开发人员，特别是编程人员；
+  软件维护人员；
+  技术管理人员；
+  执行软件质量保证计划的专门人员；   
+  参与本项目开发进程各阶段验证、确认以及负责为最后项目验收、鉴定提供相应报告的有关人员。
+  合作各方有关部门的负责人；项目组负责人和全体参加人员。

###  3、 注意事项

+  权限审查：此文档仅供技术部功能组内部使用。
+  保存备份：此文档仅在服务器上作修改，不允许本地备份。
+  该文档采用 markdown 编写规范，建议使用markdownPad或相关编辑工具查看和修改。


## 二、 项目说明

### 1、概述
 
+ 1.完成本地服务端和云服务端之间的数据交互，数据有本地服务端同步到云服务端的数据，也有云服务端同步到本地服务端的数据。
+ 2.本地服务端为局域网，云服务端为公网，请求只能有本地服务端发起：
	+ 1）本地服务端数据同步发送到云服务端：直接请求
	+ 2）本地服务端请求接收云服务端同步数据：分为两次请求，一次取数据，第二次返回云服务端所取数据插入本地服务端数据表的结果


## 三、源码说明

### 源代码说明

~~~

./
├── cloud_server                       云服务端源码（总数据端）
│  ├── README.md                           自述文件（帮助文档）
│  └──...
├── local_server                       本地服务端源码（分数据端）
│  ├── README.md                           自述文件（帮助文档）
│  └──...
└── README.md                          自述文件（帮助文档）

~~~


### 云端服务器代码目录结构

~~~

~~~

### 本地服务器代码目录结构

~~~

~~~

### 部署配置


~~~

~~~

### 数据库配置

+ 建议版本： MySQL
+ 字符集：   utf8--UTF-8 Unicode
+ 排序规则   utf8_general_ci

> 环境要求
> + PHP >= 5.4.0
> + PDO PHP Extension
> + MBstring PHP Extension
> + CURL PHP Extension


## 四、开发记录

### 1、问答记录

#### 问题:

+ 需要界面？允许数据库层面实现?

+ 同步的数据范围？只有会员和订单？

+ 本地服务端要同步到云服务端的数据数据结构变化复杂度？数据结构是否一样？

+ 数据同步的系统，是要独立运行？开发的要同步的数据的系统，其数据库的版本是什么？

+ 只有增量数据？会有减少数据的情况？

+ 同步的数据的触动方式，只有客户端发起？会有服务端推送的情况？需要使用长连接？

+ 只有共享会员与非共享会员都提交到云，但不是该提交的分店，同步不了非共享会员资料？

+ 文档里的同步类别优先级情景不是很清楚

> 时间：2018-05-17 19:04:43
回复记录：

+ 1. 需要界面？允许数据库层面实现?
    答：不需要界面，如果能保证安全性，可以考虑数据库层面操作。但目前好像做不到

+ 2. 同步的数据范围？只有会员和订单？
    答：也包括其它数据，但被同步数据与同步操作是解耦合的，数据表如下：

| Field                   |  Type        |                       Comment                           |
|-------------------------|--------------|---------------------------------------------------------|
| id                      | int(11)      |自增id                                                   |
| syn_id                  | bigint       |同步数据id                                               |
| data_detail             | text         |待同步的打包数据：基于业务动作                           |
| data_from_detail        | char         |待同步数据数组的来源：表单名、对应数据id                 |
| business_type           | int          |待同步数据业务类别                                       |
| data_from_server_id     | int(9)       |同步数据来源【发送】的服务端id                           |
| data_to_server_id       | int(9)       |同步数据同步的目标【接收】服务端id                       |
| fail_num                | tinyint(1)   |同步插入失败次数(最大为3次)，默认‘0’，即还没有同步       |
| result_of_send_business | tinyint(1)   |失败原因：                                               |
| create_time             | bigint       |同步数据创建时间：数据插入数据表时间同等级数据按时间排序 |
| data_from_client        | tinyint(2)   |数据来源（备份）:                                        |
 
+ 3. 本地服务端要同步到云服务端的数据数据结构变化复杂度？数据结构是否一样？
   答：参见上述，根据data_from_detail、business_type定义被同步data_detail的数据结构和

+ 4. 数据同步的系统，是要独立运行？开发的要同步的数据的系统，其数据库的版本是什么？
   答：同步系统独立运行，数据库预计采用Mysql8.0

+ 5. 只有增量数据？会有减少数据的情况？
   答：有减少数据

+ 6. 同步的数据的触动方式，只有客户端发起？会有服务端推送的情况？需要使用长连接？
   答：采用定时触发，需要一个守护进程，保证定时任务的可靠性。 
       局域网和公网之间的同步。采用路由器配置固定端口不可行，因为硬件环境有可能变动

+ 7. 只有共享会员与非共享会员都提交到云，但不是由原提交的分店，同步不了提交的非共享会员资料？
   答：被同步数据由顾客打包即可，数据结构需要按照定义的格式封装，同上述


#### 其他杂乱问题记录

+  同步的数据范围？ 
   + 某一数据库的所有表？
   + 某一数据库的几张表？
   + 只是一数据库的一整张表？
+  同步的数据的触动方式
   + 实时监测（间隔时间触发，自动触发）？
   + 手动触发 ？
   + 定时触发（固定时间段，客户端设定时间点）？
+  本地服务端要同步到云服务端的数据数据结构变化复杂度？数据结构是否一样
+  本地服务器同步到云服务器的数据保存方式？
   + 按版本保存
   + 按时间
+  本地数据到云端数据的单次数据量上限 
+  本地从云端更新数据的下载数量上限
+  当前数据同步的系统，是要独立运行？要同步的数据的系统，已开发完毕？数据库的版本是否已确定？
+  需要界面？允许数据库层面实现
+  云端要推送待同步的数据到本地服务？socket长连接？
+  只有共享会员与非共享会员都提交到云，但不是该提交的分店，同步不了非共享会员资料？
+  订单数据云端都有，但不能同步到其他分店，只能上传的本地服务器下载
+  类别优先级
+  特情表？
+  php 非系统服务定时任务
+  配置表、分店（企业）详情表、同步数据表、同步数据发送表、同步备忘表
+  只有增量数据？


### 2、开发日志

#### 战略

+ 登陆验证机制
  + 三套:
    + 一套是本地服务器与云端服务器对接的登陆身份验证机制
    + 一套是本地服务器登陆身份验证机制
    + 一套是云服务器登陆身份验证机制

+ 初步方案 用户认证用jwt


#### 战术



### 3、参考资料

+ ThinkPHP5.0完全开发手册（ https://www.kancloud.cn/manual/thinkphp5/118008 ）

你必须理解的三大软件原则1_DRY
https://blog.csdn.net/zj_show/article/details/8065836

你必须理解的三大软件原则2_KISS
https://blog.csdn.net/zj_show/article/details/8071473

你必须理解的三大软件原则3_YAGNI
https://blog.csdn.net/zj_show/article/details/8078447

DRY原则和Shy原则
https://blog.csdn.net/haoxing168/article/details/4455340

Danny.Dai
https://www.cnblogs.com/kinglongdai/archive/2011/10/09/2204134.html

PHP中Trait详解及其应用
https://segmentfault.com/a/1190000008009455